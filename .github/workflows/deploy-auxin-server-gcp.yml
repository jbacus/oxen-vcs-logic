name: Deploy Auxin Server to GCP

on:
  push:
    branches:
      - main
      - 'release/**'
    paths:
      - 'auxin-server/**'
      - '.github/workflows/deploy-auxin-server-gcp.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'auxin-server/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY_REPO: auxin
  SERVICE_NAME: auxin-server

jobs:
  # ====================
  # Run Tests
  # ====================
  # Tests are defined in .github/workflows/test.yml
  # We just trigger that workflow and wait for it to complete

  run-tests:
    name: Run Tests
    uses: ./.github/workflows/test.yml

  # ====================
  # Build Docker Image
  # ====================

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: run-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: auxin-server

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: auxin-server/frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: auxin-server/frontend

      - name: Build frontend
        run: npm run build
        working-directory: auxin-server/frontend

      - name: Build Docker image (test)
        run: |
          docker build \
            -t auxin-server:test \
            -f auxin-server/Dockerfile \
            auxin-server

  deploy-dev:
    name: Deploy to Development
    needs: build-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: dev

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:latest \
            -f auxin-server/Dockerfile \
            auxin-server

      - name: Push Docker image
        run: |
          docker push --all-tags ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --min-instances 0 \
            --max-instances 10 \
            --port 3000 \
            --timeout 300 \
            --set-env-vars RUST_LOG=info,auxin_server=debug,OXEN_SERVER_PORT=3000,OXEN_SERVER_HOST=0.0.0.0 \
            --set-secrets AUTH_TOKEN_SECRET=auxin-auth-secret:latest

      - name: Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

      - name: Run smoke tests
        run: |
          sleep 10  # Wait for service to be ready
          curl -f ${{ steps.service-url.outputs.url }}/health || exit 1
          echo "Health check passed!"

      - name: Notify deployment success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "âœ… Auxin Server deployed to Development",
              attachments: [{
                color: 'good',
                fields: [
                  { title: 'Environment', value: 'Development', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: true },
                  { title: 'URL', value: '${{ steps.service-url.outputs.url }}' },
                  { title: 'Deployed by', value: '${{ github.actor }}', short: true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify deployment failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "âŒ Auxin Server deployment to Development failed",
              attachments: [{
                color: 'danger',
                fields: [
                  { title: 'Environment', value: 'Development', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: true },
                  { title: 'Workflow', value: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}' }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-staging:
    name: Deploy to Staging
    needs: build-image
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/release/') && github.event_name == 'push'
    environment: staging

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}-staging:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}-staging:latest \
            -f auxin-server/Dockerfile \
            auxin-server

      - name: Push Docker image
        run: |
          docker push --all-tags ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}-staging

      - name: Deploy to Cloud Run (Staging)
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-staging \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}-staging:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --no-allow-unauthenticated \
            --memory 4Gi \
            --cpu 2 \
            --min-instances 1 \
            --max-instances 20 \
            --port 3000 \
            --timeout 300 \
            --set-env-vars RUST_LOG=info,auxin_server=info,OXEN_SERVER_PORT=3000,OXEN_SERVER_HOST=0.0.0.0 \
            --set-secrets AUTH_TOKEN_SECRET=auxin-auth-secret-staging:latest

  deploy-prod:
    name: Deploy to Production
    needs: build-image
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: prod

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_PROD }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:latest \
            -f auxin-server/Dockerfile \
            auxin-server

      - name: Push Docker image
        run: |
          docker push --all-tags ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}

      - name: Deploy to Cloud Run (Production)
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --no-allow-unauthenticated \
            --memory 8Gi \
            --cpu 4 \
            --min-instances 2 \
            --max-instances 50 \
            --port 3000 \
            --timeout 300 \
            --set-env-vars RUST_LOG=info,auxin_server=info,OXEN_SERVER_PORT=3000,OXEN_SERVER_HOST=0.0.0.0 \
            --set-secrets AUTH_TOKEN_SECRET=auxin-auth-secret-prod:latest

      - name: Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

      - name: Run smoke tests
        run: |
          sleep 10
          curl -f ${{ steps.service-url.outputs.url }}/health || exit 1
          echo "Production health check passed!"

      - name: Notify production deployment success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš€ Auxin Server deployed to PRODUCTION",
              attachments: [{
                color: 'good',
                fields: [
                  { title: 'Environment', value: 'Production', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: true },
                  { title: 'URL', value: '${{ steps.service-url.outputs.url }}' },
                  { title: 'Deployed by', value: '${{ github.actor }}', short: true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify production deployment failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš¨ CRITICAL: Auxin Server deployment to PRODUCTION failed",
              attachments: [{
                color: 'danger',
                fields: [
                  { title: 'Environment', value: 'Production', short: true },
                  { title: 'Commit', value: '${{ github.sha }}', short: true },
                  { title: 'Workflow', value: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}' },
                  { title: 'Action Required', value: 'Immediate investigation needed' }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
