name: Test Suite

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================
  # Rust CLI Tests
  # ====================

  rust-unit-tests:
    name: Rust CLI - Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: Auxin-CLI-Wrapper

    - name: Check formatting
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo fmt -- --check

    - name: Run clippy
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo clippy --lib --tests -- -D warnings

    - name: Run unit tests
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo test --lib --verbose

    - name: Build release
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo build --release

  rust-integration-tests:
    name: Rust CLI - Integration Tests
    runs-on: macos-14
    needs: rust-unit-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: Auxin-CLI-Wrapper

    - name: Install oxen CLI
      run: pip3 install oxen-ai

    - name: Run integration tests
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo test --test '*' --verbose

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: rust-integration-test-results
        path: Auxin-CLI-Wrapper/target/debug/deps/*.xml
        if-no-files-found: ignore

  # ====================
  # Rust Server Tests
  # ====================

  rust-server-tests:
    name: Rust Server - Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: auxin-server

    - name: Check formatting
      working-directory: ./auxin-server
      run: cargo fmt -- --check

    - name: Run clippy
      working-directory: ./auxin-server
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Run tests
      working-directory: ./auxin-server
      run: cargo test --features mock-oxen --verbose

  # ====================
  # Swift LaunchAgent Tests
  # ====================

  swift-launchagent:
    name: Swift LaunchAgent - Tests
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Install SwiftFormat
      run: brew install swiftformat

    - name: Check formatting
      working-directory: ./Auxin-LaunchAgent
      run: swiftformat --lint --config ../.swiftformat .

    - name: Cache Swift dependencies
      uses: actions/cache@v4
      with:
        path: |
          Auxin-LaunchAgent/.build
        key: ${{ runner.os }}-swift-launchagent-${{ hashFiles('Auxin-LaunchAgent/Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-launchagent-

    - name: Build
      working-directory: ./Auxin-LaunchAgent
      run: swift build -c release

    - name: Run tests
      working-directory: ./Auxin-LaunchAgent
      run: swift test --parallel

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: swift-launchagent-test-results
        path: Auxin-LaunchAgent/.build/debug/*Tests.xml
        if-no-files-found: ignore

  # ====================
  # Swift App Tests
  # ====================

  swift-app:
    name: Swift App - Tests
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Install SwiftFormat
      run: brew install swiftformat

    - name: Check formatting
      working-directory: ./Auxin-App
      run: swiftformat --lint --config ../.swiftformat .

    - name: Cache Swift dependencies
      uses: actions/cache@v4
      with:
        path: |
          Auxin-App/.build
        key: ${{ runner.os }}-swift-app-${{ hashFiles('Auxin-App/Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-app-

    - name: Build
      working-directory: ./Auxin-App
      run: swift build -c release

    - name: Run tests
      working-directory: ./Auxin-App
      run: swift test --parallel

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: swift-app-test-results
        path: Auxin-App/.build/debug/*Tests.xml
        if-no-files-found: ignore

  # ====================
  # Frontend Tests
  # ====================

  frontend-tests:
    name: Frontend - Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: auxin-server/frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./auxin-server/frontend
      run: npm ci

    - name: Run linting
      working-directory: ./auxin-server/frontend
      run: npm run lint

    - name: Type check
      working-directory: ./auxin-server/frontend
      run: npm run type-check

    - name: Run unit tests
      working-directory: ./auxin-server/frontend
      run: npm run test:coverage

    - name: Upload coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: auxin-server/frontend/coverage
        if-no-files-found: ignore

    - name: Build
      working-directory: ./auxin-server/frontend
      run: npm run build

  # ====================
  # Test Summary
  # ====================

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [rust-unit-tests, rust-integration-tests, rust-server-tests, swift-launchagent, swift-app, frontend-tests]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "Test Results Summary:"
        echo "  Rust CLI Unit Tests: ${{ needs.rust-unit-tests.result }}"
        echo "  Rust CLI Integration Tests: ${{ needs.rust-integration-tests.result }}"
        echo "  Rust Server Tests: ${{ needs.rust-server-tests.result }}"
        echo "  Swift LaunchAgent Tests: ${{ needs.swift-launchagent.result }}"
        echo "  Swift App Tests: ${{ needs.swift-app.result }}"
        echo "  Frontend Tests: ${{ needs.frontend-tests.result }}"

        if [[ "${{ needs.rust-unit-tests.result }}" != "success" ]] || \
           [[ "${{ needs.rust-integration-tests.result }}" != "success" ]] || \
           [[ "${{ needs.rust-server-tests.result }}" != "success" ]] || \
           [[ "${{ needs.swift-launchagent.result }}" != "success" ]] || \
           [[ "${{ needs.swift-app.result }}" != "success" ]] || \
           [[ "${{ needs.frontend-tests.result }}" != "success" ]]; then
          echo "Some tests failed!"
          exit 1
        fi

        echo "All tests passed!"
