name: E2E Tests

# E2E tests are expensive and slow, so we run them:
# - On pull requests to main (required for merge)
# - On workflow dispatch (manual trigger)
# - Nightly on main branch

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # ====================
  # Frontend E2E Tests
  # ====================

  frontend-e2e:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: auxin-server/frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./auxin-server/frontend
      run: npm ci

    - name: Install Playwright browsers
      working-directory: ./auxin-server/frontend
      run: npx playwright install --with-deps

    - name: Setup Rust (for backend)
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: auxin-server

    - name: Build backend
      working-directory: ./auxin-server
      run: cargo build --release --features mock-oxen

    - name: Start backend server
      working-directory: ./auxin-server
      run: |
        cargo run --release --features mock-oxen &
        echo $! > /tmp/backend.pid
        # Wait for server to be ready
        timeout 30 bash -c 'until curl -f http://localhost:3000/health; do sleep 1; done'

    - name: Build frontend
      working-directory: ./auxin-server/frontend
      run: npm run build

    - name: Run E2E tests
      working-directory: ./auxin-server/frontend
      run: npm run test:e2e

    - name: Stop backend server
      if: always()
      run: |
        if [ -f /tmp/backend.pid ]; then
          kill $(cat /tmp/backend.pid) || true
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: auxin-server/frontend/playwright-report
        if-no-files-found: ignore

    - name: Upload screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-screenshots
        path: auxin-server/frontend/test-results
        if-no-files-found: ignore

  # ====================
  # Full Integration Test
  # ====================

  full-integration:
    name: Full Stack Integration Test
    runs-on: macos-14
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: |
          Auxin-CLI-Wrapper
          auxin-server

    - name: Install oxen CLI
      run: pip3 install oxen-ai

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Build all Rust components
      run: |
        cd Auxin-CLI-Wrapper && cargo build --release
        cd ../auxin-server && cargo build --release --features mock-oxen

    - name: Build Swift components
      run: |
        cd Auxin-LaunchAgent && swift build -c release
        cd ../Auxin-App && swift build -c release

    - name: Run CLI integration tests
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo test --test '*' --release

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-integration-test-results
        path: |
          Auxin-CLI-Wrapper/target/release/deps/*.xml
          test-results/
        if-no-files-found: ignore

  # ====================
  # Test Summary
  # ====================

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [frontend-e2e, full-integration]
    if: always()

    steps:
    - name: Check E2E test results
      run: |
        echo "E2E Test Results Summary:"
        echo "  Frontend E2E Tests: ${{ needs.frontend-e2e.result }}"
        echo "  Full Integration Tests: ${{ needs.full-integration.result }}"

        if [[ "${{ needs.frontend-e2e.result }}" != "success" ]] || \
           [[ "${{ needs.full-integration.result }}" != "success" ]]; then
          echo "Some E2E tests failed!"
          exit 1
        fi

        echo "All E2E tests passed!"
