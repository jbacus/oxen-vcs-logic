name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================
  # CodeQL Analysis
  # ====================

  codeql-rust:
    name: CodeQL - Rust
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'rust'
        queries: security-and-quality

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Build Rust CLI
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo build --release

    - name: Build Rust Server
      working-directory: ./auxin-server
      run: cargo build --release --features mock-oxen

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "rust"

  codeql-javascript:
    name: CodeQL - JavaScript/TypeScript
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'javascript'
        queries: security-and-quality

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "javascript"

  codeql-swift:
    name: CodeQL - Swift
    runs-on: macos-14
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'swift'
        queries: security-and-quality

    - name: Build Swift LaunchAgent
      working-directory: ./Auxin-LaunchAgent
      run: swift build -c release

    - name: Build Swift App
      working-directory: ./Auxin-App
      run: swift build -c release

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "swift"

  # ====================
  # Docker Security Scanning
  # ====================

  docker-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: auxin-server/frontend/package-lock.json

    - name: Install frontend dependencies
      working-directory: ./auxin-server/frontend
      run: npm ci

    - name: Build frontend
      working-directory: ./auxin-server/frontend
      run: npm run build

    - name: Build Docker image
      run: |
        docker build \
          -t auxin-server:security-scan \
          -f auxin-server/Dockerfile \
          auxin-server

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'auxin-server:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'auxin-server:security-scan'
        format: 'table'
        severity: 'CRITICAL,HIGH,MEDIUM'

  # ====================
  # Dependency Audit
  # ====================

  cargo-audit:
    name: Rust Dependency Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run cargo audit for CLI
      working-directory: ./Auxin-CLI-Wrapper
      run: cargo audit --deny warnings || true

    - name: Run cargo audit for Server
      working-directory: ./auxin-server
      run: cargo audit --deny warnings || true

    - name: Run cargo audit for Config
      working-directory: ./auxin-config
      run: cargo audit --deny warnings || true

  npm-audit:
    name: npm Dependency Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Run npm audit
      working-directory: ./auxin-server/frontend
      run: |
        npm audit --audit-level=moderate || true
        npm audit --json > npm-audit-report.json || true

    - name: Upload npm audit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: npm-audit-report
        path: auxin-server/frontend/npm-audit-report.json
        if-no-files-found: ignore

  # ====================
  # Security Summary
  # ====================

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [codeql-rust, codeql-javascript, codeql-swift, docker-scan, cargo-audit, npm-audit]
    if: always()

    steps:
    - name: Check security scan results
      run: |
        echo "Security Scan Results Summary:"
        echo "  CodeQL Rust: ${{ needs.codeql-rust.result }}"
        echo "  CodeQL JavaScript: ${{ needs.codeql-javascript.result }}"
        echo "  CodeQL Swift: ${{ needs.codeql-swift.result }}"
        echo "  Docker Image Scan: ${{ needs.docker-scan.result }}"
        echo "  Cargo Audit: ${{ needs.cargo-audit.result }}"
        echo "  npm Audit: ${{ needs.npm-audit.result }}"

        if [[ "${{ needs.codeql-rust.result }}" != "success" ]] || \
           [[ "${{ needs.codeql-javascript.result }}" != "success" ]] || \
           [[ "${{ needs.codeql-swift.result }}" != "success" ]] || \
           [[ "${{ needs.docker-scan.result }}" != "success" ]]; then
          echo "⚠️  Some security scans reported issues!"
          echo "Check the Security tab for details"
          exit 0  # Don't fail the build, just warn
        fi

        echo "✅ All security scans passed!"
